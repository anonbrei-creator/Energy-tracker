<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Field Energy Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;1,9..144,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e10;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #c8f075;
    --accent2: #75c8f0;
    --warn: #f0a875;
    --danger: #f07575;
    --text: #e8e8ee;
    --text-dim: #888896;
    --text-dimmer: #55555f;
    --radius: 12px;
    --radius-sm: 6px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    padding: 0;
    overflow-x: hidden;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 20% 20%, rgba(200,240,117,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(117,200,240,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 24px 16px 80px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-left h1 {
    font-family: 'Fraunces', serif;
    font-size: 28px;
    font-weight: 300;
    font-style: italic;
    color: var(--text);
    line-height: 1.1;
  }

  .header-left p {
    font-size: 11px;
    color: var(--text-dimmer);
    margin-top: 4px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .date-badge {
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    line-height: 1.6;
  }

  /* Energy bar */
  .energy-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
  }

  .energy-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 12px;
  }

  .energy-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dimmer);
  }

  .energy-value {
    font-family: 'Fraunces', serif;
    font-size: 48px;
    font-weight: 300;
    line-height: 1;
    transition: color 0.5s;
  }

  .energy-bar-track {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .energy-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1), background 0.5s;
  }

  .energy-meta {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-dimmer);
  }

  /* Drain indicator */
  .drain-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.05em;
  }

  .drain-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--warn);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Setup card */
  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
  }

  .setup-card h2 {
    font-family: 'Fraunces', serif;
    font-size: 18px;
    font-weight: 300;
    font-style: italic;
    margin-bottom: 6px;
  }

  .setup-card p {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .question {
    margin-bottom: 20px;
  }

  .question label {
    display: block;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dimmer);
    margin-bottom: 8px;
  }

  .toggle-group {
    display: flex;
    gap: 8px;
  }

  .toggle-btn {
    flex: 1;
    padding: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .toggle-btn:hover { border-color: var(--text-dimmer); color: var(--text); }
  .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: #0e0e10; }
  .toggle-btn.active-warn { background: var(--warn); border-color: var(--warn); color: #0e0e10; }

  /* Section label */
  .section-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dimmer);
    margin-bottom: 12px;
    margin-top: 28px;
  }

  /* Task form */
  .task-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
  }

  .task-card.active-task {
    border-color: var(--accent2);
    box-shadow: 0 0 0 1px var(--accent2), 0 0 20px rgba(117,200,240,0.08);
  }

  input[type="text"], select, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="text"]:focus, select:focus, textarea:focus {
    border-color: var(--accent);
  }

  select option { background: var(--surface2); }

  textarea { resize: vertical; min-height: 60px; }

  .input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .input-row input { flex: 1; margin-bottom: 0; }

  /* Slider */
  .slider-group {
    margin-bottom: 16px;
  }

  .slider-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 6px;
  }

  .slider-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dimmer);
  }

  .slider-value {
    font-size: 20px;
    font-family: 'Fraunces', serif;
    font-weight: 300;
    color: var(--accent);
  }

  .slider-sublabel {
    font-size: 10px;
    color: var(--text-dimmer);
    margin-left: 4px;
  }

  input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: transform 0.2s;
  }

  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }

  /* Timer display */
  .timer-display {
    text-align: center;
    padding: 20px;
    background: var(--surface2);
    border-radius: var(--radius-sm);
    margin: 16px 0;
  }

  .timer-digits {
    font-family: 'Fraunces', serif;
    font-size: 52px;
    font-weight: 300;
    color: var(--accent2);
    letter-spacing: 0.05em;
    line-height: 1;
  }

  .timer-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dimmer);
    margin-top: 6px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.06em;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn-primary {
    background: var(--accent);
    color: #0e0e10;
    border-color: var(--accent);
  }
  .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }

  .btn-secondary {
    background: transparent;
    color: var(--text-dim);
    border-color: var(--border);
  }
  .btn-secondary:hover { border-color: var(--text-dimmer); color: var(--text); }

  .btn-danger {
    background: transparent;
    color: var(--danger);
    border-color: var(--danger);
  }
  .btn-danger:hover { background: var(--danger); color: #0e0e10; }

  .btn-blue {
    background: var(--accent2);
    color: #0e0e10;
    border-color: var(--accent2);
  }
  .btn-blue:hover { opacity: 0.85; }

  .btn-full { width: 100%; }

  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  /* Result card */
  .result-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 16px 0;
  }

  .result-box {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 14px;
    text-align: center;
  }

  .result-box-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dimmer);
    margin-bottom: 6px;
  }

  .result-box-value {
    font-family: 'Fraunces', serif;
    font-size: 32px;
    font-weight: 300;
  }

  .result-gap {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 14px;
    text-align: center;
    border: 1px solid var(--border);
    margin-bottom: 12px;
  }

  .gap-positive { color: var(--accent); }
  .gap-negative { color: var(--danger); }
  .gap-neutral { color: var(--text-dim); }

  /* History */
  .history-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .history-item:hover { border-color: var(--text-dimmer); }

  .history-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .history-task-name {
    font-size: 13px;
    color: var(--text);
  }

  .history-date {
    font-size: 10px;
    color: var(--text-dimmer);
  }

  .history-stats {
    display: flex;
    gap: 16px;
  }

  .history-stat {
    font-size: 10px;
    color: var(--text-dimmer);
  }

  .history-stat span {
    color: var(--text-dim);
    font-size: 12px;
  }

  /* Averages */
  .averages-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
  }

  .averages-card h3 {
    font-family: 'Fraunces', serif;
    font-size: 16px;
    font-weight: 300;
    font-style: italic;
    margin-bottom: 14px;
    color: var(--text-dim);
  }

  .avg-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }

  .avg-row:last-child { border-bottom: none; }

  .avg-task { color: var(--text); }
  .avg-vals { display: flex; gap: 16px; }
  .avg-predicted { color: var(--warn); font-size: 11px; }
  .avg-actual { color: var(--accent); font-size: 11px; }
  .avg-gap { font-size: 11px; }

  /* Nav tabs */
  .nav {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px;
    margin-bottom: 20px;
  }

  .nav-btn {
    flex: 1;
    padding: 8px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-dimmer);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-btn.active {
    background: var(--surface2);
    color: var(--text);
  }

  /* Notification */
  .notification {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--accent);
    color: #0e0e10;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 12px;
    letter-spacing: 0.05em;
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
    z-index: 100;
    white-space: nowrap;
  }

  .notification.show { transform: translateX(-50%) translateY(0); }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dimmer);
    font-size: 12px;
    line-height: 1.8;
  }

  .empty-state .big { font-family: 'Fraunces', serif; font-size: 32px; font-style: italic; font-weight: 300; display: block; margin-bottom: 8px; color: var(--text-dim); }

  /* Note field */
  .note-field { margin-top: 12px; }
  .note-field label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dimmer); margin-bottom: 6px; }

  /* Missed task */
  .missed-task-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: flex-end;
  }
  .missed-task-row > div { flex: 1; }
  .missed-task-row label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dimmer); margin-bottom: 6px; }

  input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="number"]:focus { border-color: var(--accent); }

  .chip {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    letter-spacing: 0.05em;
  }
  .chip-green { background: rgba(200,240,117,0.15); color: var(--accent); }
  .chip-warn { background: rgba(240,168,117,0.15); color: var(--warn); }
  .chip-danger { background: rgba(240,117,117,0.15); color: var(--danger); }

  .fade-in {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Home cards */
  .home-card {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }

  .home-card:hover { border-color: var(--accent); transform: translateX(4px); }

  .home-card-icon { font-size: 24px; flex-shrink: 0; }

  .home-card-text { flex: 1; }

  .home-card-title {
    font-family: 'Fraunces', serif;
    font-size: 20px;
    font-weight: 300;
    font-style: italic;
    color: var(--text);
    margin-bottom: 2px;
  }

  .home-card-sub {
    font-size: 11px;
    color: var(--text-dimmer);
    letter-spacing: 0.04em;
  }

  .home-card-arrow {
    color: var(--text-dimmer);
    font-size: 18px;
    transition: color 0.2s;
  }

  .home-card:hover .home-card-arrow { color: var(--accent); }

  /* Back button */
  .back-btn {
    background: none;
    border: none;
    color: var(--text-dimmer);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    cursor: pointer;
    padding: 0;
    margin-bottom: 20px;
    display: block;
    transition: color 0.2s;
    text-transform: uppercase;
  }

  .back-btn:hover { color: var(--accent); }

  /* Wrapped stat cards */
  .wrap-stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 10px;
  }

  .wrap-stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dimmer);
    margin-bottom: 6px;
  }

  .wrap-stat-value {
    font-family: 'Fraunces', serif;
    font-size: 28px;
    font-weight: 300;
    color: var(--text);
    line-height: 1.1;
    margin-bottom: 4px;
  }

  .wrap-stat-sub {
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.5;
  }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>Field Tracker</h1>
      <p>Energy cost analysis system</p>
    </div>
    <div class="date-badge" id="dateBadge"></div>
  </div>

  <!-- HOME SCREEN -->
  <div id="screen-home" class="fade-in">
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
      <button class="home-card" onclick="goToTrack()">
        <div class="home-card-icon">‚ö°</div>
        <div class="home-card-text">
          <div class="home-card-title">Track</div>
          <div class="home-card-sub">Log tasks, run the timer, see your cost</div>
        </div>
        <div class="home-card-arrow">‚Üí</div>
      </button>
      <button class="home-card" onclick="showScreen('history');renderHistory()">
        <div class="home-card-icon">üìã</div>
        <div class="home-card-text">
          <div class="home-card-title">History</div>
          <div class="home-card-sub">Every task you've logged</div>
        </div>
        <div class="home-card-arrow">‚Üí</div>
      </button>
      <button class="home-card" onclick="showScreen('averages');renderAverages()">
        <div class="home-card-icon">üìä</div>
        <div class="home-card-text">
          <div class="home-card-title">Averages</div>
          <div class="home-card-sub">Predicted vs actual over time</div>
        </div>
        <div class="home-card-arrow">‚Üí</div>
      </button>
      <button class="home-card" onclick="showScreen('wrapped');renderWrappedList()">
        <div class="home-card-icon">‚ú®</div>
        <div class="home-card-text">
          <div class="home-card-title">Wrapped</div>
          <div class="home-card-sub">Your weekly breakdowns</div>
        </div>
        <div class="home-card-arrow">‚Üí</div>
      </button>
    </div>
  </div>

  <!-- TRACK SCREEN -->
  <div id="screen-track" style="display:none">
    <button class="back-btn" onclick="showScreen('home')">‚Üê Home</button>

    <!-- Day choice -->
    <div id="dayChoiceSection" class="setup-card fade-in">
      <h2>What would you like to do?</h2>
      <p>Continue where you left off or start fresh for a new day.</p>
      <div class="toggle-group" style="margin-bottom:0">
        <button class="toggle-btn" onclick="handleNewDay()">New Day</button>
        <button class="toggle-btn" onclick="handleContinueDay()">Continue Day</button>
      </div>
    </div>

    <!-- Day Setup -->
    <div id="setupSection" class="setup-card fade-in" style="display:none">
      <h2>Start your day</h2>
      <p>Set your baseline before logging any tasks. This calibrates your energy calculations.</p>

      <div class="question">
        <label>Are you experiencing extenuating circumstances?</label>
        <div class="toggle-group">
          <button class="toggle-btn active" id="btn-no" onclick="setCircumstance(false)">No ‚Äî Starting at 100</button>
          <button class="toggle-btn" id="btn-yes" onclick="setCircumstance(true)">Yes ‚Äî Starting at 95</button>
        </div>
      </div>

      <div class="question">
        <label>When did your day actually start?</label>
        <div class="toggle-group" style="margin-bottom:8px">
          <button class="toggle-btn active" id="btn-now" onclick="setStartMode('now')">Now</button>
          <button class="toggle-btn" id="btn-custom" onclick="setStartMode('custom')">Earlier today</button>
        </div>
        <div id="customTimeInput" style="display:none;margin-top:8px">
          <input type="time" id="wakeTime" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;padding:10px 12px;outline:none;">
          <div style="font-size:10px;color:var(--text-dimmer);margin-top:6px">Passive drain will be calculated from this time forward</div>
        </div>
      </div>

      <button class="btn btn-primary btn-full" onclick="startDay()">Begin Day ‚Üí</button>
    </div>

    <!-- Energy Display -->
    <div id="energySection" style="display:none">
      <div class="energy-card fade-in">
        <div class="energy-header">
          <span class="energy-label">Current Energy</span>
          <div class="drain-pill">
            <div class="drain-dot"></div>
            <span id="drainRateLabel">‚àí2 pts/hr passive</span>
          </div>
        </div>
        <div class="energy-value" id="energyValue">100</div>
        <div class="energy-bar-track">
          <div class="energy-bar-fill" id="energyBar" style="width:100%"></div>
        </div>
        <div class="energy-meta">
          <span id="startedAtLabel">Started ‚Äî</span>
          <span id="tasksCompletedLabel">0 tasks today</span>
        </div>
      </div>

      <!-- Active timer section -->
      <div id="activeTaskSection" style="display:none"></div>

      <!-- New task form -->
      <div id="newTaskSection">
        <div class="section-label">Log a task</div>
        <div class="task-card fade-in">
          <div class="input-row">
            <input type="text" id="taskInput" placeholder="Type task or select saved..." list="taskSuggestions">
            <datalist id="taskSuggestions"></datalist>
          </div>

          <div class="slider-group">
            <div class="slider-header">
              <span class="slider-label">Predicted Dread</span>
              <span><span class="slider-value" id="dreadVal">5</span><span class="slider-sublabel">/ 10</span></span>
            </div>
            <input type="range" min="1" max="10" value="5" id="dreadSlider" oninput="document.getElementById('dreadVal').textContent=this.value">
          </div>

          <div class="slider-group">
            <div class="slider-header">
              <span class="slider-label">Physical Toll</span>
              <span><span class="slider-value" id="physVal">5</span><span class="slider-sublabel">/ 10</span></span>
            </div>
            <input type="range" min="1" max="10" value="5" id="physSlider" oninput="document.getElementById('physVal').textContent=this.value">
          </div>

          <div class="slider-group">
            <div class="slider-header">
              <span class="slider-label">Mental Focus Required</span>
              <span><span class="slider-value" id="mentalVal">5</span><span class="slider-sublabel">/ 10</span></span>
            </div>
            <input type="range" min="1" max="10" value="5" id="mentalSlider" oninput="document.getElementById('mentalVal').textContent=this.value">
          </div>

          <div style="margin-bottom:12px">
            <label style="display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dimmer);margin-bottom:6px">What specifically do you think will be hard?</label>
            <input type="text" id="whatHardInput" placeholder="Optional ‚Äî name the specific dread...">
          </div>

          <button class="btn btn-blue btn-full" onclick="startTask()">Start Task + Timer ‚Üí</button>

          <div class="divider"></div>
          <div style="font-size:11px;color:var(--text-dimmer);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.08em">Log task you already did (no timer)</div>
          <div class="missed-task-row">
            <div>
              <label>Duration (minutes)</label>
              <input type="number" id="missedDuration" placeholder="e.g. 45" min="1">
            </div>
          </div>
          <button class="btn btn-secondary btn-full" onclick="logMissedTask()">Log Without Timer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY SCREEN -->
  <div id="screen-history" style="display:none">
    <button class="back-btn" onclick="showScreen('home')">‚Üê Home</button>
    <div class="section-label">Task History</div>
    <div id="historyList"></div>
  </div>

  <!-- WRAPPED LIST SCREEN -->
  <div id="screen-wrapped" style="display:none">
    <button class="back-btn" onclick="showScreen('home')">‚Üê Home</button>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="section-label" style="margin:0">Wrapped</div>
      <button class="btn btn-primary" style="font-size:11px;padding:7px 14px" onclick="showGenerateWrapped()">+ Generate</button>
    </div>

    <!-- Generate form -->
    <div id="generateWrappedForm" style="display:none" class="setup-card fade-in">
      <h2>Generate a Wrap</h2>
      <p>Select a date range to generate your wrapped report. Works best for a full week.</p>
      <div style="display:flex;gap:12px;margin-bottom:16px">
        <div style="flex:1">
          <label style="display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dimmer);margin-bottom:6px">From</label>
          <input type="date" id="wrapStartDate" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:10px 12px;outline:none;">
        </div>
        <div style="flex:1">
          <label style="display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dimmer);margin-bottom:6px">To</label>
          <input type="date" id="wrapEndDate" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:10px 12px;outline:none;">
        </div>
      </div>
      <div class="btn-row" style="margin-top:0">
        <button class="btn btn-secondary" style="flex:1" onclick="document.getElementById('generateWrappedForm').style.display='none'">Cancel</button>
        <button class="btn btn-primary" style="flex:1" onclick="generateWrapped()">Generate ‚Üí</button>
      </div>
    </div>

    <div id="wrappedList"></div>
  </div>

  <!-- WRAPPED DETAIL SCREEN -->
  <div id="screen-wrapped-detail" style="display:none">
    <button class="back-btn" onclick="showScreen('wrapped');renderWrappedList()">‚Üê Wrapped</button>
    <div id="wrappedDetailContent"></div>
  </div>
  <div id="screen-edit" style="display:none">
    <button class="back-btn" onclick="showScreen('history');renderHistory()">‚Üê History</button>
    <div class="section-label">Edit Task</div>
    <div class="task-card fade-in">

      <div style="margin-bottom:16px">
        <label style="display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dimmer);margin-bottom:6px">Task Name</label>
        <input type="text" id="editTaskName" placeholder="Task name">
      </div>

      <div style="font-family:'Fraunces',serif;font-size:14px;font-style:italic;color:var(--text-dim);margin-bottom:12px">Predicted</div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Dread</span>
          <span><span class="slider-value" id="editPredDreadVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editPredDreadSlider" oninput="document.getElementById('editPredDreadVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Physical Toll</span>
          <span><span class="slider-value" id="editPredPhysVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editPredPhysSlider" oninput="document.getElementById('editPredPhysVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Mental Focus</span>
          <span><span class="slider-value" id="editPredMentalVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editPredMentalSlider" oninput="document.getElementById('editPredMentalVal').textContent=this.value">
      </div>

      <div class="divider"></div>
      <div style="font-family:'Fraunces',serif;font-size:14px;font-style:italic;color:var(--text-dim);margin-bottom:12px">Actual</div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Dread</span>
          <span><span class="slider-value" id="editActDreadVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editActDreadSlider" oninput="document.getElementById('editActDreadVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Physical Toll</span>
          <span><span class="slider-value" id="editActPhysVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editActPhysSlider" oninput="document.getElementById('editActPhysVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Mental Focus</span>
          <span><span class="slider-value" id="editActMentalVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editActMentalSlider" oninput="document.getElementById('editActMentalVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">How did you feel after?</span>
          <span><span class="slider-value" id="editAfterFeelVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="editAfterFeelSlider" oninput="document.getElementById('editAfterFeelVal').textContent=this.value">
      </div>

      <div class="note-field">
        <label>Notes</label>
        <textarea id="editNotes" placeholder="Any context or observations..."></textarea>
      </div>

      <div class="btn-row" style="margin-top:20px">
        <button class="btn btn-danger" style="flex:1" onclick="confirmDeleteEntry()">Delete</button>
        <button class="btn btn-primary" style="flex:1" onclick="saveEditedEntry()">Save</button>
      </div>
    </div>
  </div>

  <!-- AVERAGES SCREEN -->
  <div id="screen-averages" style="display:none">
    <button class="back-btn" onclick="showScreen('home')">‚Üê Home</button>
    <div class="section-label">Per-Task Averages</div>
    <div class="averages-card">
      <h3>Predicted vs. Actual Cost</h3>
      <div style="font-size:10px;color:var(--text-dimmer);margin-bottom:12px;display:flex;gap:16px">
        <span style="color:var(--warn)">‚ñ† predicted</span>
        <span style="color:var(--accent)">‚ñ† actual</span>
        <span style="color:var(--accent2)">‚ñ† gap saved</span>
      </div>
      <div id="averagesList"></div>
    </div>
    <div style="font-size:11px;color:var(--text-dimmer);text-align:center;padding:12px">
      The gap between predicted and actual is your brain recalibrating.<br>Watch it shrink over time.
    </div>
    <button class="btn btn-danger btn-full" onclick="clearAllData()" style="margin-top:8px">Clear All Data</button>
    
    <div class="divider"></div>
    <div class="section-label" style="margin-top:0">Data Backup</div>
    <div style="font-size:11px;color:var(--text-dimmer);margin-bottom:12px;line-height:1.6">Export your data to back it up or move it to a new device. Import to restore.</div>
    <div class="btn-row" style="margin-top:0">
      <button class="btn btn-secondary" style="flex:1" onclick="exportData()">‚¨á Export Data</button>
      <button class="btn btn-secondary" style="flex:1" onclick="document.getElementById('importFile').click()">‚¨Ü Import Data</button>
    </div>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>

</div>

<!-- Modal overlay -->
<div id="modalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:50;display:none;align-items:center;justify-content:center;padding:24px">
  <div id="modalBox" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:400px;width:100%">
    <div id="modalTitle" style="font-family:'Fraunces',serif;font-size:18px;font-weight:300;font-style:italic;margin-bottom:8px"></div>
    <div id="modalBody" style="font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.6"></div>
    <div id="modalButtons" style="display:flex;gap:8px"></div>
  </div>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<script>
// =====================
// STATE
// =====================
let state = {
  dayStarted: false,
  extenuating: false,
  startMode: 'now',
  startEnergy: 100,
  dayStartTime: null,
  currentEnergy: 100,
  tasksCompleted: 0,
  activeTask: null,
  timerInterval: null,
  passiveDrainInterval: null,
};

const DRAIN_NORMAL = 2;      // pts per hour
const DRAIN_EXTENUATING = 3; // pts per hour
const TIME_COST_NORMAL = 1;       // per 30 min
const TIME_COST_EXTENUATING = 1.5; // per 30 min

// =====================
// STORAGE
// =====================
function saveState() {
  localStorage.setItem('fieldtracker_state', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('fieldtracker_state');
  if (saved) {
    const s = JSON.parse(saved);
    // Check if it's still the same day
    if (s.dayStartTime) {
      const savedDate = new Date(s.dayStartTime).toDateString();
      const today = new Date().toDateString();
      if (savedDate === today) {
        state = s;
        return true;
      }
    }
  }
  return false;
}

function getHistory() {
  return JSON.parse(localStorage.getItem('fieldtracker_history') || '[]');
}

function saveToHistory(entry) {
  const history = getHistory();
  history.unshift(entry);
  localStorage.setItem('fieldtracker_history', JSON.stringify(history));
}

function getSavedTasks() {
  return JSON.parse(localStorage.getItem('fieldtracker_tasks') || '[]');
}

function saveTask(name) {
  const tasks = getSavedTasks();
  if (!tasks.includes(name)) {
    tasks.push(name);
    localStorage.setItem('fieldtracker_tasks', JSON.stringify(tasks));
  }
}

function clearAllData() {
  if (confirm('Clear all history and averages? This cannot be undone.')) {
    localStorage.removeItem('fieldtracker_history');
    localStorage.removeItem('fieldtracker_tasks');
    showNotification('All data cleared');
    renderHistory();
    renderAverages();
    updateTaskSuggestions();
  }
}

// =====================
// INIT
// =====================
window.onload = function() {
  updateDateBadge();
  loadState();
  showScreen('home');
  updateTaskSuggestions();
};

// =====================
// SCREEN NAVIGATION
// =====================
function showScreen(name) {
  ['home','track','history','averages','edit','wrapped','wrapped-detail'].forEach(s => {
    document.getElementById('screen-' + s).style.display = s === name ? 'block' : 'none';
  });
}

function goToTrack() {
  showScreen('track');
  showDayChoice(true);
}

function showDayChoice(show) {
  document.getElementById('dayChoiceSection').style.display = show ? 'block' : 'none';
  document.getElementById('setupSection').style.display = 'none';
  document.getElementById('energySection').style.display = 'none';
}

function handleNewDay() {
  showModal(
    'Start a new day?',
    'Any progress tracked today will be reset. Your full history and averages are kept.',
    [
      { label: "Yes, new day", style: 'btn-primary', action: () => { closeModal(); resetDayState(); showSetup(); } },
      { label: "Cancel", style: 'btn-secondary', action: closeModal }
    ]
  );
}

function handleContinueDay() {
  const history = getHistory();
  const today = new Date().toDateString();
  const todayEntries = history.filter(h => new Date(h.timestamp).toDateString() === today);

  if (todayEntries.length === 0 && !state.dayStarted) {
    const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    showModal(
      'No data logged today',
      `Nothing has been logged for ${dateStr}. Redirecting to New Day setup...`,
      [{ label: "OK", style: 'btn-primary', action: () => { closeModal(); resetDayState(); showSetup(); } }]
    );
    return;
  }

  // Has data or active day ‚Äî continue
  closeModal();
  showDayChoice(false);
  showDayActive();
  recalcEnergy();
  startPassiveDrain();
  if (state.activeTask) renderActiveTask();
}

function showSetup() {
  document.getElementById('dayChoiceSection').style.display = 'none';
  document.getElementById('setupSection').style.display = 'block';
  document.getElementById('energySection').style.display = 'none';
}

function resetDayState() {
  if (state.passiveDrainInterval) clearInterval(state.passiveDrainInterval);
  if (state.timerInterval) clearInterval(state.timerInterval);
  state.dayStarted = false;
  state.extenuating = false;
  state.startMode = 'now';
  state.startEnergy = 100;
  state.dayStartTime = null;
  state.currentEnergy = 100;
  state.tasksCompleted = 0;
  state.activeTask = null;
  state.timerInterval = null;
  state.passiveDrainInterval = null;
  saveState();
}

// =====================
// MODAL
// =====================
function showModal(title, body, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').textContent = body;
  const btnContainer = document.getElementById('modalButtons');
  btnContainer.innerHTML = '';
  buttons.forEach(b => {
    const btn = document.createElement('button');
    btn.className = 'btn ' + b.style;
    btn.style.flex = '1';
    btn.textContent = b.label;
    btn.onclick = b.action;
    btnContainer.appendChild(btn);
  });
  const overlay = document.getElementById('modalOverlay');
  overlay.style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
}

function updateDateBadge() {
  const now = new Date();
  document.getElementById('dateBadge').innerHTML = 
    now.toLocaleDateString('en-US', { weekday: 'long' }) + '<br>' +
    now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + '<br>' +
    now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  setTimeout(updateDateBadge, 10000);
}

// =====================
// DAY SETUP
// =====================
function setCircumstance(val) {
  state.extenuating = val;
  document.getElementById('btn-yes').className = 'toggle-btn' + (val ? ' active-warn' : '');
  document.getElementById('btn-no').className = 'toggle-btn' + (!val ? ' active' : '');
}

function setStartMode(mode) {
  state.startMode = mode;
  document.getElementById('btn-now').className = 'toggle-btn' + (mode === 'now' ? ' active' : '');
  document.getElementById('btn-custom').className = 'toggle-btn' + (mode === 'custom' ? ' active' : '');
  document.getElementById('customTimeInput').style.display = mode === 'custom' ? 'block' : 'none';
  if (mode === 'custom') {
    // Default the time input to 1 hour ago as a helpful starting point
    const anHourAgo = new Date(Date.now() - 3600000);
    document.getElementById('wakeTime').value = anHourAgo.toTimeString().slice(0,5);
  }
}

function startDay() {
  state.dayStarted = true;
  state.startEnergy = state.extenuating ? 95 : 100;
  state.tasksCompleted = 0;

  // Figure out when the day actually started
  if (state.startMode === 'custom') {
    const timeVal = document.getElementById('wakeTime').value;
    if (timeVal) {
      const [hours, minutes] = timeVal.split(':').map(Number);
      const wakeDate = new Date();
      wakeDate.setHours(hours, minutes, 0, 0);
      // If the time is in the future somehow, use now
      state.dayStartTime = wakeDate.getTime() > Date.now() ? Date.now() : wakeDate.getTime();
    } else {
      state.dayStartTime = Date.now();
    }
  } else {
    state.dayStartTime = Date.now();
  }

  // Calculate how much passive drain has already occurred
  const hoursElapsed = (Date.now() - state.dayStartTime) / 3600000;
  const rate = state.extenuating ? DRAIN_EXTENUATING : DRAIN_NORMAL;
  const alreadyDrained = hoursElapsed * rate;
  state.currentEnergy = Math.max(0, state.startEnergy - alreadyDrained);

  saveState();
  showDayActive();
  startPassiveDrain();

  const drained = (state.startEnergy - state.currentEnergy).toFixed(1);
  const msg = state.startMode === 'custom' && drained > 0
    ? `Started at ${state.startEnergy}, already drained ${drained} pts ‚Äî you're at ${state.currentEnergy.toFixed(1)}`
    : state.extenuating ? 'Day started at 95 ‚Äî extenuating mode on' : 'Day started at 100 ‚Äî let\'s go';
  showNotification(msg);
}

function showDayActive() {
  document.getElementById('setupSection').style.display = 'none';
  document.getElementById('energySection').style.display = 'block';
  const rate = state.extenuating ? DRAIN_EXTENUATING : DRAIN_NORMAL;
  document.getElementById('drainRateLabel').textContent = `‚àí${rate} pts/hr passive`;
  updateEnergyDisplay();
}

// =====================
// PASSIVE DRAIN
// =====================
function recalcEnergy() {
  if (!state.dayStartTime) return;
  const hoursElapsed = (Date.now() - state.dayStartTime) / 3600000;
  const rate = state.extenuating ? DRAIN_EXTENUATING : DRAIN_NORMAL;
  const passiveLost = hoursElapsed * rate;
  // Also subtract task costs that have been logged
  const history = getHistory();
  const today = new Date().toDateString();
  const todayTasks = history.filter(h => new Date(h.timestamp).toDateString() === today);
  const taskCost = todayTasks.reduce((sum, t) => sum + (t.actualCost || 0), 0);
  state.currentEnergy = Math.max(0, state.startEnergy - passiveLost - taskCost);
  saveState();
}

function startPassiveDrain() {
  if (state.passiveDrainInterval) clearInterval(state.passiveDrainInterval);
  state.passiveDrainInterval = setInterval(() => {
    recalcEnergy();
    updateEnergyDisplay();
  }, 30000); // update every 30s
}

function updateEnergyDisplay() {
  const e = Math.max(0, Math.round(state.currentEnergy * 10) / 10);
  document.getElementById('energyValue').textContent = e.toFixed(1);
  const pct = (e / 100) * 100;
  const bar = document.getElementById('energyBar');
  bar.style.width = pct + '%';

  let color;
  if (e > 60) color = 'var(--accent)';
  else if (e > 30) color = 'var(--warn)';
  else color = 'var(--danger)';

  bar.style.background = color;
  document.getElementById('energyValue').style.color = color;

  const started = new Date(state.dayStartTime);
  document.getElementById('startedAtLabel').textContent = 'Started ' + started.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
  document.getElementById('tasksCompletedLabel').textContent = state.tasksCompleted + ' task' + (state.tasksCompleted !== 1 ? 's' : '') + ' today';
}

// =====================
// TASK SUGGESTIONS
// =====================
function updateTaskSuggestions() {
  const dl = document.getElementById('taskSuggestions');
  if (!dl) return;
  const tasks = getSavedTasks();
  dl.innerHTML = tasks.map(t => `<option value="${t}">`).join('');
}

// =====================
// START TASK
// =====================
function startTask() {
  const name = document.getElementById('taskInput').value.trim();
  if (!name) { showNotification('Name your task first'); return; }

  const dread = parseInt(document.getElementById('dreadSlider').value);
  const phys = parseInt(document.getElementById('physSlider').value);
  const mental = parseInt(document.getElementById('mentalSlider').value);
  const whatHard = document.getElementById('whatHardInput').value.trim();

  const predictedCost = calcCost(dread, phys, mental, 0, false);

  state.activeTask = {
    name,
    dread,
    phys,
    mental,
    whatHard,
    predictedCost,
    startTime: Date.now(),
    elapsed: 0,
  };

  saveTask(name);
  updateTaskSuggestions();
  saveState();

  document.getElementById('newTaskSection').style.display = 'none';
  renderActiveTask();
  showNotification('Timer started ‚Äî go do the thing');
}

function renderActiveTask() {
  const t = state.activeTask;
  if (!t) return;

  const section = document.getElementById('activeTaskSection');
  section.style.display = 'block';
  section.innerHTML = `
    <div class="section-label">Active Task</div>
    <div class="task-card active-task fade-in">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:14px;color:var(--text)">${t.name}</div>
        <div class="chip chip-green">running</div>
      </div>
      <div class="timer-display">
        <div class="timer-digits" id="timerDigits">00:00:00</div>
        <div class="timer-label">elapsed time</div>
      </div>
      <div style="font-size:11px;color:var(--text-dimmer);margin:12px 0">
        Predicted cost: <span style="color:var(--warn)">${t.predictedCost.toFixed(1)} pts</span>
        ${t.whatHard ? `<br>Dreading: ${t.whatHard}` : ''}
      </div>
      <button class="btn btn-primary btn-full" onclick="finishTask()">Finish Task ‚Üí</button>
    </div>
  `;

  startTimer();
}

function startTimer() {
  if (state.timerInterval) clearInterval(state.timerInterval);
  state.timerInterval = setInterval(() => {
    if (!state.activeTask) return;
    state.activeTask.elapsed = Date.now() - state.activeTask.startTime;
    const el = document.getElementById('timerDigits');
    if (el) el.textContent = formatDuration(state.activeTask.elapsed);
    saveState();
  }, 1000);
}

function formatDuration(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return [h,m,sec].map(x => String(x).padStart(2,'0')).join(':');
}

function formatDurationShort(ms) {
  const totalMin = Math.round(ms / 60000);
  if (totalMin < 60) return `${totalMin}m`;
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

// =====================
// FINISH TASK
// =====================
function finishTask() {
  if (state.timerInterval) clearInterval(state.timerInterval);
  const t = state.activeTask;
  const elapsed = t.elapsed || (Date.now() - t.startTime);

  // Show post-task form
  const section = document.getElementById('activeTaskSection');
  section.innerHTML = `
    <div class="section-label">Post-Task Check-In</div>
    <div class="task-card fade-in">
      <div style="margin-bottom:16px">
        <div style="font-size:13px;color:var(--text);margin-bottom:4px">${t.name}</div>
        <div style="font-size:11px;color:var(--text-dimmer)">Actual time: <span style="color:var(--accent2)">${formatDurationShort(elapsed)}</span></div>
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Actual Dread (vs reality)</span>
          <span><span class="slider-value" id="actualDreadVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="actualDreadSlider" oninput="document.getElementById('actualDreadVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Actual Physical Toll</span>
          <span><span class="slider-value" id="actualPhysVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="actualPhysSlider" oninput="document.getElementById('actualPhysVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">Actual Mental Drain</span>
          <span><span class="slider-value" id="actualMentalVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="actualMentalSlider" oninput="document.getElementById('actualMentalVal').textContent=this.value">
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <span class="slider-label">How do you feel now that it's done?</span>
          <span><span class="slider-value" id="afterFeelVal">5</span><span class="slider-sublabel">/ 10</span></span>
        </div>
        <input type="range" min="1" max="10" value="5" id="afterFeelSlider" oninput="document.getElementById('afterFeelVal').textContent=this.value">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-dimmer);margin-top:4px"><span>worse</span><span>better</span></div>
      </div>

      <div class="note-field">
        <label>Notes (optional)</label>
        <textarea id="taskNotes" placeholder="What was actually hard? What helped? Any context..."></textarea>
      </div>

      <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="saveTask_final(${elapsed})">Save + See Results ‚Üí</button>
    </div>
  `;
}

function saveTask_final(elapsed) {
  const t = state.activeTask;
  const actualDread = parseInt(document.getElementById('actualDreadSlider').value);
  const actualPhys = parseInt(document.getElementById('actualPhysSlider').value);
  const actualMental = parseInt(document.getElementById('actualMentalSlider').value);
  const afterFeel = parseInt(document.getElementById('afterFeelSlider').value);
  const notes = document.getElementById('taskNotes').value.trim();

  const minutesElapsed = elapsed / 60000;
  const timeCost = (minutesElapsed / 30) * (state.extenuating ? TIME_COST_EXTENUATING : TIME_COST_NORMAL);
  const actualCost = calcCost(actualDread, actualPhys, actualMental, timeCost, true);
  const predictedCost = t.predictedCost;
  const gap = predictedCost - actualCost;

  // Save to history
  const entry = {
    name: t.name,
    timestamp: Date.now(),
    extenuating: state.extenuating,
    predicted: { dread: t.dread, phys: t.phys, mental: t.mental },
    actual: { dread: actualDread, phys: actualPhys, mental: actualMental },
    predictedCost,
    actualCost,
    gap,
    afterFeel,
    notes,
    elapsed,
    whatHard: t.whatHard,
  };

  saveToHistory(entry);
  state.tasksCompleted++;
  state.activeTask = null;
  recalcEnergy();
  updateEnergyDisplay();
  saveState();

  // Show result
  showResult(entry);
}

function logMissedTask() {
  const name = document.getElementById('taskInput').value.trim();
  const mins = parseInt(document.getElementById('missedDuration').value);
  if (!name) { showNotification('Name your task first'); return; }
  if (!mins || mins < 1) { showNotification('Enter duration in minutes'); return; }

  const dread = parseInt(document.getElementById('dreadSlider').value);
  const phys = parseInt(document.getElementById('physSlider').value);
  const mental = parseInt(document.getElementById('mentalSlider').value);

  const timeCost = (mins / 30) * (state.extenuating ? TIME_COST_EXTENUATING : TIME_COST_NORMAL);
  const actualCost = calcCost(dread, phys, mental, timeCost, true);

  const entry = {
    name,
    timestamp: Date.now(),
    extenuating: state.extenuating,
    predicted: { dread, phys, mental },
    actual: { dread, phys, mental },
    predictedCost: actualCost,
    actualCost,
    gap: 0,
    afterFeel: 5,
    notes: 'Logged without timer',
    elapsed: mins * 60000,
    noTimer: true,
  };

  saveTask(name);
  updateTaskSuggestions();
  saveToHistory(entry);
  state.tasksCompleted++;
  recalcEnergy();
  updateEnergyDisplay();
  saveState();
  showNotification('Task logged ‚Äî ' + formatDurationShort(entry.elapsed));
  resetTaskForm();
  renderHistory();
  renderAverages();
}

// =====================
// COST CALC
// =====================
function calcCost(dread, phys, mental, timeCost, isActual) {
  return (dread * 0.5) + (phys * 0.5) + (mental * 0.75) + timeCost;
}

// =====================
// SHOW RESULT
// =====================
function showResult(entry) {
  const section = document.getElementById('activeTaskSection');
  const gap = entry.gap;
  const gapClass = gap > 0 ? 'gap-positive' : gap < 0 ? 'gap-negative' : 'gap-neutral';
  const gapLabel = gap > 0 ? `Your brain overestimated by ${gap.toFixed(1)} pts` : gap < 0 ? `Actually cost ${Math.abs(gap).toFixed(1)} pts more than expected` : 'Prediction was accurate';

  section.innerHTML = `
    <div class="section-label">Results</div>
    <div class="task-card fade-in">
      <div style="font-size:14px;color:var(--text);margin-bottom:4px">${entry.name}</div>
      <div style="font-size:11px;color:var(--text-dimmer);margin-bottom:16px">${formatDurationShort(entry.elapsed)} ¬∑ ${new Date(entry.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</div>

      <div class="result-grid">
        <div class="result-box">
          <div class="result-box-label">Predicted Cost</div>
          <div class="result-box-value" style="color:var(--warn)">${entry.predictedCost.toFixed(1)}</div>
        </div>
        <div class="result-box">
          <div class="result-box-label">Actual Cost</div>
          <div class="result-box-value" style="color:var(--accent)">${entry.actualCost.toFixed(1)}</div>
        </div>
      </div>

      <div class="result-gap">
        <div class="result-box-label">Gap</div>
        <div class="result-box-value ${gapClass}">${gap > 0 ? '+' : ''}${gap.toFixed(1)}</div>
        <div style="font-size:11px;color:var(--text-dimmer);margin-top:4px">${gapLabel}</div>
      </div>

      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-dimmer);padding:8px 0;border-top:1px solid var(--border)">
        <span>How you feel after</span>
        <span style="color:var(--accent)">${entry.afterFeel}/10</span>
      </div>

      ${entry.notes ? `<div style="font-size:11px;color:var(--text-dimmer);padding:8px 0;border-top:1px solid var(--border);font-style:italic">"${entry.notes}"</div>` : ''}

      <div class="btn-row">
        <button class="btn btn-primary" style="flex:1" onclick="nextTask()">Log Another</button>
        <button class="btn btn-secondary" style="flex:1" onclick="showTab('history')">View History</button>
      </div>
    </div>
  `;

  renderHistory();
  renderAverages();
}

function nextTask() {
  document.getElementById('activeTaskSection').style.display = 'none';
  document.getElementById('newTaskSection').style.display = 'block';
  resetTaskForm();
}

function resetTaskForm() {
  document.getElementById('taskInput').value = '';
  document.getElementById('dreadSlider').value = 5;
  document.getElementById('physSlider').value = 5;
  document.getElementById('mentalSlider').value = 5;
  document.getElementById('dreadVal').textContent = '5';
  document.getElementById('physVal').textContent = '5';
  document.getElementById('mentalVal').textContent = '5';
  document.getElementById('whatHardInput').value = '';
  document.getElementById('missedDuration').value = '';
}

// =====================
// HISTORY
// =====================
function renderHistory() {
  const list = document.getElementById('historyList');
  if (!list) return;
  const history = getHistory();
  if (history.length === 0) {
    list.innerHTML = `<div class="empty-state"><span class="big">nothing yet</span>Start tracking tasks to build your data.</div>`;
    return;
  }

  list.innerHTML = history.map((entry, i) => {
    const gap = entry.gap;
    const gapChip = gap > 1 ? `<span class="chip chip-green">saved ${gap.toFixed(1)} pts</span>` :
                    gap < -1 ? `<span class="chip chip-danger">cost ${Math.abs(gap).toFixed(1)} more</span>` :
                    `<span class="chip" style="background:rgba(136,136,150,0.15);color:var(--text-dim)">on target</span>`;

    return `<div class="history-item fade-in">
      <div class="history-item-header">
        <span class="history-task-name">${entry.name}</span>
        <span class="history-date">${new Date(entry.timestamp).toLocaleDateString('en-US',{month:'short',day:'numeric'})} ¬∑ ${new Date(entry.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</span>
      </div>
      <div class="history-stats">
        <div class="history-stat">predicted <span>${entry.predictedCost.toFixed(1)}</span></div>
        <div class="history-stat">actual <span>${entry.actualCost.toFixed(1)}</span></div>
        <div class="history-stat">time <span>${formatDurationShort(entry.elapsed)}</span></div>
        ${gapChip}
      </div>
      ${entry.notes ? `<div style="font-size:10px;color:var(--text-dimmer);margin-top:8px;font-style:italic">"${entry.notes}"</div>` : ''}
      <button class="btn btn-secondary" style="margin-top:10px;font-size:10px;padding:6px 12px" onclick="openEditEntry(${entry.timestamp})">Edit</button>
    </div>`;
  }).join('');
}

// =====================
// EDIT / DELETE ENTRY
// =====================
let editingTimestamp = null;

function openEditEntry(timestamp) {
  const history = getHistory();
  const entry = history.find(e => e.timestamp === timestamp);
  if (!entry) return;

  editingTimestamp = timestamp;

  document.getElementById('editTaskName').value = entry.name;

  // Predicted
  const pd = entry.predicted || {};
  document.getElementById('editPredDreadSlider').value = pd.dread || 5;
  document.getElementById('editPredDreadVal').textContent = pd.dread || 5;
  document.getElementById('editPredPhysSlider').value = pd.phys || 5;
  document.getElementById('editPredPhysVal').textContent = pd.phys || 5;
  document.getElementById('editPredMentalSlider').value = pd.mental || 5;
  document.getElementById('editPredMentalVal').textContent = pd.mental || 5;

  // Actual
  const ac = entry.actual || {};
  document.getElementById('editActDreadSlider').value = ac.dread || 5;
  document.getElementById('editActDreadVal').textContent = ac.dread || 5;
  document.getElementById('editActPhysSlider').value = ac.phys || 5;
  document.getElementById('editActPhysVal').textContent = ac.phys || 5;
  document.getElementById('editActMentalSlider').value = ac.mental || 5;
  document.getElementById('editActMentalVal').textContent = ac.mental || 5;

  document.getElementById('editAfterFeelSlider').value = entry.afterFeel || 5;
  document.getElementById('editAfterFeelVal').textContent = entry.afterFeel || 5;
  document.getElementById('editNotes').value = entry.notes || '';

  showScreen('edit');
}

function saveEditedEntry() {
  const history = getHistory();
  const idx = history.findIndex(e => e.timestamp === editingTimestamp);
  if (idx === -1) return;

  const entry = history[idx];

  const predDread = parseInt(document.getElementById('editPredDreadSlider').value);
  const predPhys = parseInt(document.getElementById('editPredPhysSlider').value);
  const predMental = parseInt(document.getElementById('editPredMentalSlider').value);
  const actDread = parseInt(document.getElementById('editActDreadSlider').value);
  const actPhys = parseInt(document.getElementById('editActPhysSlider').value);
  const actMental = parseInt(document.getElementById('editActMentalSlider').value);
  const afterFeel = parseInt(document.getElementById('editAfterFeelSlider').value);
  const notes = document.getElementById('editNotes').value.trim();
  const name = document.getElementById('editTaskName').value.trim() || entry.name;

  const minutesElapsed = entry.elapsed / 60000;
  const timeCost = (minutesElapsed / 30) * (entry.extenuating ? TIME_COST_EXTENUATING : TIME_COST_NORMAL);
  const predictedCost = calcCost(predDread, predPhys, predMental, timeCost);
  const actualCost = calcCost(actDread, actPhys, actMental, timeCost);
  const gap = predictedCost - actualCost;

  history[idx] = {
    ...entry,
    name,
    predicted: { dread: predDread, phys: predPhys, mental: predMental },
    actual: { dread: actDread, phys: actPhys, mental: actMental },
    predictedCost,
    actualCost,
    gap,
    afterFeel,
    notes,
  };

  // If entry is from today, adjust energy by the difference in actual cost
  if (state.dayStarted) {
    const entryDate = new Date(entry.timestamp).toDateString();
    const today = new Date().toDateString();
    if (entryDate === today) {
      const costDiff = entry.actualCost - actualCost;
      state.currentEnergy = Math.min(state.startEnergy, Math.max(0, state.currentEnergy + costDiff));
      saveState();
      updateEnergyDisplay();
    }
  }

  localStorage.setItem('fieldtracker_history', JSON.stringify(history));
  saveTask(name);
  updateTaskSuggestions();
  showNotification('Entry saved');
  showScreen('history');
  renderHistory();
  renderAverages();
}

function confirmDeleteEntry() {
  showModal(
    'Delete this entry?',
    'This task will be permanently removed from your history and averages. This cannot be undone.',
    [
      { label: 'Delete', style: 'btn-danger', action: () => {
        const history = getHistory();
        const entry = history.find(e => e.timestamp === editingTimestamp);

        // If the entry is from today and a day is active, refund the energy cost
        if (entry && state.dayStarted) {
          const entryDate = new Date(entry.timestamp).toDateString();
          const today = new Date().toDateString();
          if (entryDate === today) {
            state.currentEnergy = Math.min(state.startEnergy, state.currentEnergy + entry.actualCost);
            state.tasksCompleted = Math.max(0, state.tasksCompleted - 1);
            saveState();
            updateEnergyDisplay();
          }
        }

        const newHistory = history.filter(e => e.timestamp !== editingTimestamp);
        localStorage.setItem('fieldtracker_history', JSON.stringify(newHistory));
        closeModal();
        showNotification('Entry deleted ‚Äî points refunded');
        showScreen('history');
        renderHistory();
        renderAverages();
      }},
      { label: 'Cancel', style: 'btn-secondary', action: closeModal }
    ]
  );
}

// =====================
// AVERAGES
// =====================
function renderAverages() {
  const list = document.getElementById('averagesList');
  if (!list) return;
  const history = getHistory();
  if (history.length === 0) {
    list.innerHTML = `<div style="font-size:12px;color:var(--text-dimmer);padding:20px 0;text-align:center">No data yet</div>`;
    return;
  }

  // Group by task name
  const byTask = {};
  history.forEach(entry => {
    if (!byTask[entry.name]) byTask[entry.name] = [];
    byTask[entry.name].push(entry);
  });

  const rows = Object.entries(byTask).map(([name, entries]) => {
    const avgPredicted = entries.reduce((s, e) => s + e.predictedCost, 0) / entries.length;
    const avgActual = entries.reduce((s, e) => s + e.actualCost, 0) / entries.length;
    const avgGap = avgPredicted - avgActual;
    const gapColor = avgGap > 0 ? 'var(--accent2)' : avgGap < 0 ? 'var(--danger)' : 'var(--text-dim)';

    return `<div class="avg-row">
      <span class="avg-task">${name} <span style="color:var(--text-dimmer);font-size:10px">(${entries.length}x)</span></span>
      <div class="avg-vals">
        <span class="avg-predicted">${avgPredicted.toFixed(1)}</span>
        <span class="avg-actual">${avgActual.toFixed(1)}</span>
        <span class="avg-gap" style="color:${gapColor}">${avgGap > 0 ? '+' : ''}${avgGap.toFixed(1)}</span>
      </div>
    </div>`;
  }).join('');

  list.innerHTML = rows;
}

// =====================
// TABS (legacy redirect)
// =====================
function showTab(tab) {
  if (tab === 'history') { showScreen('history'); renderHistory(); }
  if (tab === 'averages') { showScreen('averages'); renderAverages(); }
}

// =====================
// EXPORT / IMPORT
// =====================
function exportData() {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    history: getHistory(),
    tasks: getSavedTasks(),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'field-tracker-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showNotification('Data exported ‚Äî save that file somewhere safe');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.history || !Array.isArray(data.history)) {
        showNotification('Invalid file ‚Äî import failed');
        return;
      }
      showModal(
        'Import data?',
        `This will merge ${data.history.length} entries with your existing data. Your current data won't be deleted.`,
        [
          { label: 'Import', style: 'btn-primary', action: () => {
            // Merge history (avoid duplicates by timestamp)
            const existing = getHistory();
            const existingTimestamps = new Set(existing.map(e => e.timestamp));
            const newEntries = data.history.filter(e => !existingTimestamps.has(e.timestamp));
            const merged = [...existing, ...newEntries].sort((a,b) => b.timestamp - a.timestamp);
            localStorage.setItem('fieldtracker_history', JSON.stringify(merged));
            // Merge saved tasks
            if (data.tasks) {
              const existingTasks = getSavedTasks();
              const mergedTasks = [...new Set([...existingTasks, ...data.tasks])];
              localStorage.setItem('fieldtracker_tasks', JSON.stringify(mergedTasks));
            }
            closeModal();
            renderHistory();
            renderAverages();
            updateTaskSuggestions();
            showNotification(`Imported ${newEntries.length} new entries`);
          }},
          { label: 'Cancel', style: 'btn-secondary', action: closeModal }
        ]
      );
    } catch(err) {
      showNotification('Could not read file ‚Äî import failed');
    }
    // Reset file input so same file can be imported again if needed
    event.target.value = '';
  };
  reader.readAsText(file);
}

// =====================
// WRAPPED
// =====================
function getWraps() {
  return JSON.parse(localStorage.getItem('fieldtracker_wraps') || '[]');
}

function saveWraps(wraps) {
  localStorage.setItem('fieldtracker_wraps', JSON.stringify(wraps));
}

function showGenerateWrapped() {
  const form = document.getElementById('generateWrappedForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'block') {
    // Default to most recent Sunday-Saturday
    const now = new Date();
    const day = now.getDay(); // 0=Sun
    const lastSun = new Date(now);
    lastSun.setDate(now.getDate() - day - 7);
    const lastSat = new Date(lastSun);
    lastSat.setDate(lastSun.getDate() + 6);
    document.getElementById('wrapStartDate').value = lastSun.toISOString().slice(0,10);
    document.getElementById('wrapEndDate').value = lastSat.toISOString().slice(0,10);
  }
}

function generateWrapped() {
  const startVal = document.getElementById('wrapStartDate').value;
  const endVal = document.getElementById('wrapEndDate').value;

  if (!startVal || !endVal) { showNotification('Pick a start and end date'); return; }

  const startDate = new Date(startVal + 'T00:00:00');
  const endDate = new Date(endVal + 'T23:59:59');

  if (startDate > endDate) { showNotification('Start date must be before end date'); return; }

  const history = getHistory();
  const entries = history.filter(e => {
    const d = new Date(e.timestamp);
    return d >= startDate && d <= endDate;
  });

  if (entries.length === 0) {
    showNotification('No data found in that date range');
    return;
  }

  // Check if wrap already exists for this range
  const wraps = getWraps();
  const exists = wraps.find(w => w.startDate === startVal && w.endDate === endVal);
  if (exists) {
    showModal(
      'Wrap already exists',
      'A wrap for this date range already exists. Do you want to regenerate it with current data?',
      [
        { label: 'Regenerate', style: 'btn-primary', action: () => {
          closeModal();
          buildAndSaveWrap(startVal, endVal, startDate, endDate, entries, wraps, exists);
        }},
        { label: 'Cancel', style: 'btn-secondary', action: closeModal }
      ]
    );
    return;
  }

  buildAndSaveWrap(startVal, endVal, startDate, endDate, entries, wraps, null);
}

function buildAndSaveWrap(startVal, endVal, startDate, endDate, entries, wraps, existing) {
  // Group entries by day
  const byDay = {};
  entries.forEach(e => {
    const day = new Date(e.timestamp).toDateString();
    if (!byDay[day]) byDay[day] = [];
    byDay[day].push(e);
  });

  const activeDays = Object.keys(byDay);
  const taskCountsByDay = activeDays.map(d => byDay[d].length);

  // Longest streak of consecutive days
  const sortedDays = activeDays.map(d => new Date(d)).sort((a,b) => a-b);
  let longestStreak = 1, currentStreak = 1;
  for (let i = 1; i < sortedDays.length; i++) {
    const diff = (sortedDays[i] - sortedDays[i-1]) / 86400000;
    if (diff === 1) { currentStreak++; longestStreak = Math.max(longestStreak, currentStreak); }
    else currentStreak = 1;
  }

  // Most/least tasks in a day
  const mostTasksDay = activeDays.reduce((a, b) => byDay[a].length >= byDay[b].length ? a : b);
  const leastTasksDay = activeDays.reduce((a, b) => byDay[a].length <= byDay[b].length ? a : b);

  // Biggest/smallest gap (individual tasks)
  const withGaps = entries.filter(e => !e.noTimer);
  const biggestGapEntry = withGaps.length ? withGaps.reduce((a, b) => a.gap >= b.gap ? a : b) : null;
  const smallestGapEntry = withGaps.length ? withGaps.reduce((a, b) => Math.abs(a.gap) <= Math.abs(b.gap) ? a : b) : null;

  // Most drained day
  const mostDrainedDay = activeDays.reduce((a, b) => {
    const costA = byDay[a].reduce((s, e) => s + e.actualCost, 0);
    const costB = byDay[b].reduce((s, e) => s + e.actualCost, 0);
    return costA >= costB ? a : b;
  });
  const mostDrainedCost = byDay[mostDrainedDay].reduce((s, e) => s + e.actualCost, 0);

  // Most logged task
  const taskCounts = {};
  entries.forEach(e => { taskCounts[e.name] = (taskCounts[e.name] || 0) + 1; });
  const mostLoggedTask = Object.entries(taskCounts).reduce((a, b) => a[1] >= b[1] ? a : b);

  // Average gap across all tasks
  const avgGap = withGaps.length ? withGaps.reduce((s, e) => s + e.gap, 0) / withGaps.length : 0;

  const wrap = {
    id: Date.now(),
    startDate: startVal,
    endDate: endVal,
    totalTasks: entries.length,
    activeDays: activeDays.length,
    longestStreak,
    mostTasksDay,
    mostTasksCount: byDay[mostTasksDay].length,
    leastTasksDay,
    leastTasksCount: byDay[leastTasksDay].length,
    biggestGapEntry,
    smallestGapEntry,
    mostDrainedDay,
    mostDrainedCost: mostDrainedCost.toFixed(1),
    mostLoggedTask: mostLoggedTask[0],
    mostLoggedCount: mostLoggedTask[1],
    avgGap: avgGap.toFixed(1),
  };

  if (existing) {
    const idx = wraps.findIndex(w => w.startDate === startVal && w.endDate === endVal);
    wraps[idx] = wrap;
  } else {
    wraps.unshift(wrap);
  }

  saveWraps(wraps);
  document.getElementById('generateWrappedForm').style.display = 'none';
  renderWrappedList();
  showNotification('Wrap generated');
}

function renderWrappedList() {
  const list = document.getElementById('wrappedList');
  const wraps = getWraps();

  if (wraps.length === 0) {
    list.innerHTML = `<div class="empty-state"><span class="big">nothing yet</span>Hit Generate to create your first wrap.</div>`;
    return;
  }

  list.innerHTML = wraps.map(w => {
    const start = new Date(w.startDate + 'T00:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
    const end = new Date(w.endDate + 'T00:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    return `<div class="history-item fade-in" onclick="openWrappedDetail(${w.id})" style="cursor:pointer">
      <div class="history-item-header">
        <span class="history-task-name" style="font-family:'Fraunces',serif;font-style:italic">${start} ‚Äî ${end}</span>
        <span class="history-date">‚Üí</span>
      </div>
      <div class="history-stats">
        <div class="history-stat">tasks <span>${w.totalTasks}</span></div>
        <div class="history-stat">active days <span>${w.activeDays}</span></div>
        <div class="history-stat">avg gap <span style="color:${parseFloat(w.avgGap) > 0 ? 'var(--accent2)' : 'var(--danger)'}">${parseFloat(w.avgGap) > 0 ? '+' : ''}${w.avgGap}</span></div>
      </div>
    </div>`;
  }).join('');
}

function openWrappedDetail(id) {
  const wraps = getWraps();
  const w = wraps.find(w => w.id === id);
  if (!w) return;

  const start = new Date(w.startDate + 'T00:00:00').toLocaleDateString('en-US', {month:'long', day:'numeric'});
  const end = new Date(w.endDate + 'T00:00:00').toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});

  const fmtDay = d => new Date(d).toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});

  const content = document.getElementById('wrappedDetailContent');
  content.innerHTML = `
    <div style="font-family:'Fraunces',serif;font-size:24px;font-weight:300;font-style:italic;margin-bottom:4px">${start} ‚Äî ${end}</div>
    <div style="font-size:11px;color:var(--text-dimmer);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:24px">${w.totalTasks} tasks ¬∑ ${w.activeDays} active days</div>

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">üî• Longest Streak</div>
      <div class="wrap-stat-value">${w.longestStreak} day${w.longestStreak !== 1 ? 's' : ''}</div>
      <div class="wrap-stat-sub">consecutive days with at least one task logged</div>
    </div>

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">üìà Most Tasks in a Day</div>
      <div class="wrap-stat-value">${w.mostTasksCount} tasks</div>
      <div class="wrap-stat-sub">${fmtDay(w.mostTasksDay)}</div>
    </div>

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">üìâ Least Tasks in a Day</div>
      <div class="wrap-stat-value">${w.leastTasksCount} task${w.leastTasksCount !== 1 ? 's' : ''}</div>
      <div class="wrap-stat-sub">${fmtDay(w.leastTasksDay)}</div>
    </div>

    ${w.biggestGapEntry ? `<div class="wrap-stat-card">
      <div class="wrap-stat-label">üéØ Biggest Gap</div>
      <div class="wrap-stat-value" style="color:var(--accent2)">+${w.biggestGapEntry.gap.toFixed(1)} pts</div>
      <div class="wrap-stat-sub">${w.biggestGapEntry.name} ‚Äî your brain overestimated the most here</div>
    </div>` : ''}

    ${w.smallestGapEntry ? `<div class="wrap-stat-card">
      <div class="wrap-stat-label">üéØ Smallest Gap</div>
      <div class="wrap-stat-value" style="color:var(--accent)">${w.smallestGapEntry.gap.toFixed(1)} pts</div>
      <div class="wrap-stat-sub">${w.smallestGapEntry.name} ‚Äî your prediction was closest here</div>
    </div>` : ''}

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">‚ö° Most Drained Day</div>
      <div class="wrap-stat-value" style="color:var(--warn)">${w.mostDrainedCost} pts</div>
      <div class="wrap-stat-sub">${fmtDay(w.mostDrainedDay)}</div>
    </div>

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">üîÅ Most Logged Task</div>
      <div class="wrap-stat-value">${w.mostLoggedTask}</div>
      <div class="wrap-stat-sub">logged ${w.mostLoggedCount} time${w.mostLoggedCount !== 1 ? 's' : ''} this period</div>
    </div>

    <div class="wrap-stat-card">
      <div class="wrap-stat-label">üìä Average Gap This Period</div>
      <div class="wrap-stat-value" style="color:${parseFloat(w.avgGap) > 0 ? 'var(--accent2)' : 'var(--danger)'}">${parseFloat(w.avgGap) > 0 ? '+' : ''}${w.avgGap} pts</div>
      <div class="wrap-stat-sub">${parseFloat(w.avgGap) > 0 ? 'Your brain overestimated on average ‚Äî recalibration is working' : 'Tasks cost more than expected on average this period'}</div>
    </div>

    <button class="btn btn-danger btn-full" style="margin-top:20px" onclick="deleteWrap(${w.id})">Delete This Wrap</button>
  `;

  showScreen('wrapped-detail');
}

function deleteWrap(id) {
  showModal(
    'Delete this wrap?',
    'This wrapped report will be permanently removed. Your task history is not affected.',
    [
      { label: 'Delete', style: 'btn-danger', action: () => {
        const wraps = getWraps().filter(w => w.id !== id);
        saveWraps(wraps);
        closeModal();
        showScreen('wrapped');
        renderWrappedList();
        showNotification('Wrap deleted');
      }},
      { label: 'Cancel', style: 'btn-secondary', action: closeModal }
    ]
  );
}

// =====================
// NOTIFICATION
// =====================
function showNotification(msg) {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}
</script>
</body>
</html>
